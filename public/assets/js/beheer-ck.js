$("document").ready(function(){$("a[data-rel]").each(function(){$(this).attr("rel",$(this).data("rel"))});folderpath=$(".maincontent").data("folderpath");PageManager.init();PageEditor.init()});var PageManager={apiUrl:"http://colorrecovery.dev/beheer/api/",currentSlug:"",currentSlugType:"",init:function(){this.apiUrl=$(".main").data("url")+"beheer/api/";$("#modalWindow").on("hidden",function(){$(this).removeData("modal")})},loadPage:function(e){$.ajax({type:"GET",url:PageManager.apiUrl+"page/"+e,dataType:"json",data:"",success:function(e){$(".content").empty();for(var t=0;t<e.parts.length;t++)$(".content").append(e.parts[t])},complete:function(e){}})},editCollection:function(e){var t=$(".editcollection").serialize();$.ajax({type:"POST",url:PageManager.apiUrl+"editmaincollection/"+e,data:t,dataType:"json",complete:function(e){},success:function(e){window.location=window.location},error:function(e){}})},deletePage:function(e){var t=confirm("Deze pagina verwijderen? ");if(!t)return!1;window.location="/beheer/page/delete/"+e},populateModal:function(){},linkcreatorSetup:function(e,t){var n=this;$("#linkerList").columnview({onchange:function(e){n.currentSlugType=$(e).data("linktype");n.currentSlug=$(e).data("slug")}});e!=undefined&&t!=undefined&&$("#linkerList").columnview("setOpen",e,t)},linkToExistingPage:function(e,t){var n=this.getLinkAndTypeDivs(e,t);n.slugDiv.html(this.currentSlug);n.typeDiv.html(this.currentSlugType);PageEditor.saveTemplate(e);$("#modalWindow").modal("hide")},linkToNewPage:function(e,t,n,r){var i=this;$.ajax({type:"POST",url:PageManager.apiUrl+"createnewpage",data:{name:t,pagetemplateid:e},dataType:"json",complete:function(e){},success:function(t){var s=t.slug,o=i.getLinkAndTypeDivs(e,r);o.slugDiv.html(s);o.typeDiv.html(n);i.currentSlugType=n;i.currentSlug=s;PageEditor.saveTemplate(e,PageManager.navigateToCreatedPage);$("#modalWindow").modal("hide");PageEditor.init()},error:function(e){}})},linkToExternalPage:function(e,t,n){n.indexOf("http://")<0&&(n="http://"+n);var r=this.getLinkAndTypeDivs(e,t);r.slugDiv.html(n);r.typeDiv.html("external");PageEditor.saveTemplate(e,null);$("#modalWindow").modal("hide");PageEditor.init()},getLinkAndTypeDivs:function(e,t){var n={};$itemholder=$("#template-"+e+' .template-itemholder [data-key="slug"]');if($itemholder.length>0)$itemholder.each(function(){if($itemholder.index(this)==t){$slugDiv=$(this);$typeDiv=$(this).parents(".template-item").find('[data-key="typeSlug"]');n.slugDiv=$slugDiv;n.typeDiv=$typeDiv}});else{n.slugDiv=$("#template-"+e+' [data-key="slug"]');n.typeDiv=$("#template-"+e+' [data-key="typeSlug"]')}return n},linkToPage:function(){},navigateToCreatedPage:function(){$.ajax({type:"POST",url:PageManager.apiUrl+"pagebyslugandtype",data:{slug:PageManager.currentSlug,type:PageManager.currentSlugType},dataType:"json",complete:function(e){},success:function(e){window.location="/beheer/page/edit/"+e.page},error:function(e){}})}},PageEditor={ready:!1,page_id:"",rootUrl:"",init:function(e){var t=this;this.page_id=$(".page_editor").data("pageid");$(".news.facebook, .news.twitter").each(function(){$(this).find(".btn").remove();$(this).find(".template-item").removeClass("template-item");$(this).children().find("[data-editable]").removeAttr("data-editable").removeAttr("contenteditable")});$(".textheader-edit input").unbind("click").click(function(e){e.stopPropagation()}).unbind("change").bind("change",function(e){$(this).parents().find(".savebtn").filter(":first").addClass("btn-warning",{duration:500})});$("#sortable").length>0&&$("#sortable").sortable({handle:".label"});if($("#sortable2").length>0){$("#sortable2").sortable({handle:".label"});$("#sortable2 .label").unbind("click").click(function(e){e.stopPropagation();var t=$(this),n=t.find(".showcnt"),r=t.find(".navbar"),i=t.parents("li").find(".details");if(!i.is(":visible")){i.slideDown();n.removeClass("icon-arrow-down").addClass("icon-arrow-up");r.css("display","block");r.animate({opacity:1},500)}else{i.slideUp();n.removeClass("icon-arrow-up").addClass("icon-arrow-down");r.find(".savebtn").hasClass("btn-warning")||r.animate({opacity:0},500,function(){$(this).css("display","none")})}})}$("#sortable2").unbind("sortstop").bind("sortstop",function(e){var t=[];$(".page_editor .sortitem").each(function(e){var n=$(this).attr("id").split("-")[1],r=$(".page_editor .sortitem").index(this);t[r]=n;var i=r;i<10&&(i="0"+i);$(this).find(".part_number").filter(":first").html(i)});$.ajax({type:"POST",url:PageManager.apiUrl+"updatetemplatesorting",data:{positions:t},dataType:"json",complete:function(e){},success:function(e){},error:function(e){}})});$('[data-editable="true"]').unbind().click(function(e){e.stopPropagation();$(this).attr("contentEditable","true");$("#sortable2").sortable("disable");$(".template-itemholder").sortable().sortable("disable");this.removeEventListener("input");this.addEventListener("input",function(e){$(this).attr("data-changed","true");$(this).parents().find(".savebtn").filter(":first").addClass("btn-warning",{duration:500})},!1);this.removeEventListener("paste");this.addEventListener("paste",function(e){var t=e.target;setTimeout(function(){$(t).html($(t).text())},50)});$(this).blur(function(e){$("#sortable2").sortable("enable");$(".template-itemholder").sortable("enable")});$(this).unbind("keydown").keydown(function(e){if(e.keyCode===13){e.preventDefault();if(window.getSelection){var t=window.getSelection();if(t.getRangeAt&&t.rangeCount){var n=document.createElement("br"),r=t.getRangeAt(0);r.insertNode(n);r.setStartAfter(n);r.collapse(!0);t.removeAllRanges();t.addRange(r)}}else document.selection&&document.selection.createRange&&document.selection.createRange().pasteHTML("<br/>")}});$(this).focus()});$("[data-key].hidden").each(function(){$(this).attr("style","");$(this).removeClass("hidden");$(this).data("description")&&$(this).before('<div class="field-description">'+$(this).data("description")+"</div>")});$('[data-editable="select"]').each(function(){var e,t,n;n=$(this).data("value");t=$(this).data("select").split("|");e="<select>";for(var r=0;r<t.length;r++){e+='<option value="'+t[r]+'"';t[r]==n&&(e+=" selected");e+=">"+t[r]+"</option>"}e+="</select>";$(this).html(e)});$('div[id^="mediaplayer-"]').each(function(){var e=$(this).attr("id");e.indexOf("_wrapper")<0&&jwplayer(e).setup({flashplayer:"/assets/jwplayer/jwplayer.flash.swf",width:"100%",height:400,file:$(this).data("url"),controlbar:"bottom"})});$(".template-itemholder .template-item").each(function(){var e=$(this).find('[data-key="image"]').html(),n=$(".template-itemholder .template-item").index(this),r=$(this).parents().find(".btn-group").data("templateid");$(this).find(".remove-item").length<1&&$(this).append('<a class="btn remove-item"><i class="icon icon-remove"></i></a>');$(this).parents(".details").find(".footerbar").removeClass("hidden");$(".addtemplateitem").unbind().click(function(e){e.stopPropagation();var n=$(e.target.parentNode).data("templateid");t.addTemplateItem(n)});$(".remove-item").unbind("click").click(function(e){e.stopPropagation();var t=$(e.target).parents(".template-itemholder").find(".template-item").length;if(t>1){var n=confirm("Dit gedeelte verwijderen?");if(n){var r=$(e.target).parents(".template-item").filter(":first"),i=$(r).find('[data-key="slug"]').html(),s=$(r).parents(".template-itemholder").filter(":first"),o=$(r).parents(".sortitem").attr("id").substr(9),u=0;$(s).find(".template-item").each(function(e){this===r[0]&&$.ajax({type:"POST",url:PageManager.apiUrl+"removetemplateitem/"+o+"/"+u,data:"",dataType:"json",complete:function(e){},success:function(e){$(r).animate({opacity:0,height:0},500,function(){$(this).remove()})},error:function(e){}});u++})}}});$(this).unbind().mouseover(function(e){$("#sortable2").sortable("disable");$(".template-itemholder").sortable({items:".template-item"}).sortable("enable").unbind("sortstop").bind("sortstop",function(){if($(this).find(".main_image").length>1)var e=$(this).find('[data-key="slug"]').html();$(this).parents().find(".savebtn").filter(":first").addClass("btn-warning",{duration:500})});$(this).mouseout(function(e){$("#sortable2").sortable("enable")})})});$(".sortitem").each(function(){itemIndex=0;$(this).find('[data-key="slug"]').each(function(){var e=$(this).parents(".sortitem").attr("id").substr(9);$(this.parentNode).find(".sluglink").length||$(this).after('<a class="sluglink btn" href="/beheer/modal/linkcreator/'+e+"/"+itemIndex+'"'+' role="button" data-toggle="modal" data-target="#modalWindow"><i class="icon-arrow-right"></i></a>');$(this).html()!=""&&$(this).parent().find(".follow-item").length<1&&$(this).parent().append('<a class="btn follow-item"><i class="icon icon-chevron-right"></i></a>');itemIndex++})});$(".follow-item").unbind().click(function(e){e.stopPropagation();var t=$(e.target).parents(".template-item").filter(":first");if(t.length==0){var n=$(e.target).parents(".sortitem").attr("id").substr(9),r=-1;$.ajax({type:"GET",url:PageManager.apiUrl+"pagebyitem/"+n+"/"+r,data:"",dataType:"json",cache:!1,complete:function(e){},success:function(e){window.location="/beheer/page/edit/"+e.page},error:function(e){}})}else{var i=$(t).parents(".template-itemholder").filter(":first"),n=$(t).parents(".sortitem").attr("id").substr(9),r=0;$(i).find(".template-item").each(function(){this===t[0]&&$.ajax({type:"GET",url:PageManager.apiUrl+"pagebyitem/"+n+"/"+r,data:"",dataType:"json",cache:!1,complete:function(e){},success:function(e){window.location="/beheer/page/edit/"+e.page},error:function(e){}});r++})}});t.rootUrl=$(".main").data("url");$('[data-key="image_id"]').each(function(){$(this).attr("style","display:none");if($(this).attr("id")){var e=-1,n=$(this).attr("id").substr(14),r=$(this).html();$(this).parents(".template-itemholder").length>0&&(e=$("#template-"+n+' .preview [data-key="image_id"]').index(this));$(this.parentNode).find(".removeimg").length||$(this).after('<a title="Afbeelding verwijderen" class="removeimg btn"><i class="icon icon-ban-circle"></i></a>');$(this.parentNode).find(".croplink").length?$(this.parentNode).find(".croplink").attr("href",t.rootUrl+"beheer/modal/imagecropper/"+r+"/"+n+"/"+e):$(this).after('<a title="Afbeelding aanpassen" class="croplink btn" href="'+t.rootUrl+"beheer/modal/imagecropper/"+r+"/"+n+"/"+e+'" role="button" data-toggle="modal" data-target="#modalWindow"><i class="icon icon-picture"></i></a>')}});$(".navbar .savebtn").unbind("click").click(function(e){e.stopPropagation();var n=$(e.target).parents("li.sortitem");n=$(n).attr("id").substr(9);t.saveTemplate(n,null)});$(".navbar .deletebtn").unbind("click").click(function(e){e.stopPropagation();var n=$(e.target).parents("li.sortitem");n=$(n).attr("id").substr(9);t.deleteTemplate(n)});$(".navbar .publishbtn").unbind("click").click(function(e){e.stopPropagation();var n=$(e.target).parents("li.sortitem");n=$(n).attr("id").substr(9);t.publishTemplate(n)});$(".removeimg").unbind("click").click(function(e){var t=$(e.target).parents(".template-item");t.find(".item-image").parents().filter(":first").remove()});$(".new-item .label").click();$(".new-item").removeClass("new-item");this.ready===!1&&$(".sortlist .sortitem:first-child .label").click();this.ready=!0},addTemplate:function(e){var t=this,n=$(e).data("page"),r=$(e).data("template");$.ajax({type:"POST",cache:!1,url:PageManager.apiUrl+"addtemplate",data:"page_id="+n+"&template_id="+r,dataType:"json",success:function(e){var n=$(e.admin_template),r=parseInt($(".sortitem").length,10);r<10&&(r="0"+r);$(n).addClass("new-item");$(n).find(".preview").html(e.html);$(n).find(".part_number").html(r);$("#sortable2").append(n).sortable("refresh");$("#modalWindow").modal("hide");t.init()},error:function(e){console.log(e)},complete:function(e){}})},addTemplateItem:function(e){var t=$("#template-"+e+" .template-item:first").clone();t.find('[data-key="image_id"]').html("-1");t.find('[data-key="slug"]').html("-");t.find(".item-image").prop("src","");t.find(".croplink, .sluglink").remove();$.ajax({type:"GET",url:PageManager.apiUrl+"templatemetadata/list/items",data:{},dataType:"json",success:function(n){for(var r in n.cfg)t.find('[data-key="'+r+'"]').html(n.cfg[r]);$("#template-"+e+" .template-itemholder").append(t);PageEditor.init()}})},saveTemplate:function(e,t){var n=0,r=0,i=this,s="",o=$("#template-"+e+" .template-item"),u=$("#template-"+e).find(".facebook,.twitter");$('[data-editable="select"]').each(function(){var e;e=$(this).find("select").attr("value");$(this).data("value",e);$(this).html(e)});if(o.length>0&&u.length<1){s+="&itemcount="+o.length;$("li#template-"+e+" .preview [data-editable]").each(function(){if(!$(this).parents(".template-itemholder").length){var e=$(this).data("key"),t=$(this).html();s+="&"+e+"="+t}});$(o).each(function(){n++;var e=$(this).find("[data-editable]");e.each(function(){var e=$(this).data("key"),t=$(this).html();s+="&item"+n+"-"+e+"="+t})})}else $("li#template-"+e+" [data-editable]").each(function(){var e=$(this).data("key"),t=$(this).html();s+="&"+e+"="+t});$("li#template-"+e+" .textheader-edit input").each(function(){var e=$(this).attr("name"),t=$(this).attr("value");s+="&"+e+"="+t});var a=$("li#template-"+e).parents(".sortitem");$.ajax({type:"POST",url:PageManager.apiUrl+"savetemplate/"+e+"/"+i.page_id,data:s,dataType:"json",complete:function(e){},success:function(r){$("li#template-"+e+' [data-key="slug"]').each(function(){var t=$("li#template-"+e+' [data-key="slug"]').index(this);r&&r.slugs&&$(this).html(r.slugs[t])});if(r&&r.data){var i=r.data;if(i.items){var s=$("li#template-"+e).find(".template-item");for(n=0;n<s.length;n++)var o=$(s[n]).find('[data-key="id"]'),u=$(s[n]).find('[data-key="slug"]'),a=i.items[n]}}$("li#template-"+e+" .savebtn").addClass("btn-success",{duration:500});setTimeout(function(){$("li#template-"+e+" .savebtn").removeClass("btn-success").removeClass("btn-warning")},3e3);t!=undefined&&t()},error:function(t){$("li#template-"+e+" .savebtn").addClass("btn-danger",{duration:500});setTimeout(function(){$("li#template-"+e+" .savebtn").removeClass("btn-danger").removeClass("btn-warning")},3e3)}});this.init()},deleteTemplate:function(e){if($(".sortitem").length>1){var t=confirm("Dit gedeelte verwijderen?");t&&$.ajax({type:"POST",url:PageManager.apiUrl+"deletetemplate/"+e,data:"",dataType:"json",complete:function(e){},success:function(t){$("li#template-"+e).animate({opacity:0,height:0},400,function(){$(this).remove();$("#sortable2").trigger("sortstop")})},error:function(e){}})}},addNewImage:function(e){},editExistingImage:function(e){$.ajax({type:"POST",url:PageManager.apiUrl+"editExistingImage",data:e,dataType:"json",complete:function(e){},success:function(e){$("#modalWindow").modal("hide")},error:function(e){}})},saveAll:function(){$("#sortable2 .sortitem").each(function(){var e=$(this).attr("id").substr(9);PageEditor.saveTemplate(e,null)})},publishPage:function(e){$.ajax({type:"POST",url:PageManager.apiUrl+"publishpage/"+e+"?t="+(new Date).getTime()+"&r="+Math.random(),data:{},dataType:"jsonp",cache:!1,complete:function(e){},success:function(e){var t="";e.newstate===1?t="open":t="close";$(".btn.publishpage i").attr("class","icon-eye-"+t)},error:function(e){}})},publishTemplate:function(e){$.ajax({type:"POST",url:PageManager.apiUrl+"publishtemplate/"+e+"?t="+(new Date).getTime()+"&r="+Math.random(),data:{},dataType:"jsonp",cache:!1,complete:function(e){},success:function(t){var n="";t.newstate===1?n="open":n="close";$("#template-"+e+" .publishbtn i").attr("class","icon-eye-"+n)},error:function(e){}})}};